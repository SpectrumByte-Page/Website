<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forum - SPECTRUM.BYTE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="    https://cdn.tailwindcss.com    "></script>
  <link rel="icon" type="image/png" href="img/ico.png" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Inter', 'sans-serif'],
          },
          screens: {
            xs: '480px',
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #0b1120 0%, #131e33 100%);
      color: white;
      min-height: 100vh;
    }
    .glow-text {
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    @keyframes bounce-slow {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .animate-bounce-slow {
      animation: bounce-slow 3s infinite;
    }
    .fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="font-sans">

  <!-- ===== HALAMAN LOGIN ===== -->
<div id="loginPage" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999]">
    <div class="bg-[rgba(13,20,35,0.8)] rounded-xl p-8 border border-cyan-500/30 max-w-md w-full mx-4 shadow-2xl animate-fade-in-up">
      <div class="text-center mb-6">
        <h2 class="text-xl font-bold text-transparent bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text">Login ke Forum</h2>
      </div>
      <div class="space-y-4">
        <!-- Tombol Login Google yang diperbarui -->
        <button id="googleLoginBtn"
                class="w-full px-5 py-2 bg-red-600 hover:bg-red-500 text-white font-medium rounded-lg transition uppercase tracking-wide text-sm flex items-center justify-center gap-2 group">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="group-hover:scale-110 transition-transform">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.25 1.12-1.03 2.13-2.21 2.75V21h3.75c2.18-1.76 3.56-4.5 3.56-7.5z" fill="#4285F4"/>
            <path d="M12 21c1.17 0 2.21-.36 3.06-1.01l-3.06-3.06V12h-3.75v4.26c-.85.65-1.89 1.01-3.06 1.01z" fill="#34A853"/>
            <path d="M5.94 12.25c-.78 0-1.53.07-2.25.2v3.75h4.26c.65-.85 1.01-1.89 1.01-3.06z" fill="#FBBC05"/>
            <path d="M12 5.25c1.17 0 2.21.36 3.06 1.01L12 9.32V12H8.25V8.25c0-1.17.36-2.21 1.01-3.06z" fill="#EA4335"/>
          </svg>
          LOGIN WITH GOOGLE
        </button>
      </div>
      <!-- Hapus elemen "Belum punya akun?" karena tidak diperlukan -->
    </div>
  </div>

  <!-- ===== NAVBAR ATAS ===== -->
  <nav id="mainNav" class="fixed top-0 left-0 right-0 z-[9999] bg-black/80 backdrop-blur-sm border-b border-cyan-500/20 px-4 py-2 flex items-center justify-between hidden">
    <!-- Kiri: Logo + Nama Brand -->
    <div class="flex items-center gap-2">
      <a href="index.html">
        <img src="img/Logo.png" alt="Spectrum.Byte" class="w-7 h-7 rounded-full border border-cyan-400 shadow-[0_0_8px_rgba(0,255,255,0.4)]">
      </a>
      <a href="index.html" class="text-base font-bold text-transparent bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text">Home</a>
    </div>

    <!-- Tengah: Menu Kategori -->
    <div class="flex space-x-4">
      <button onclick="switchCategory('kritik')" id="menuKritik" 
              class="px-3 py-1 text-sm font-medium rounded-md text-gray-400 hover:text-gray-200">Kritik</button>
      <button onclick="switchCategory('Hardware & Software')" id="menuHardware & Software" 
              class="px-3 py-1 text-sm font-medium rounded-md text-gray-400 hover:text-gray-200">Hardware & Software</button>
      <button onclick="switchCategory('ai')" id="menuAi" 
              class="px-3 py-1 text-sm font-medium rounded-md text-gray-400 hover:text-gray-200">AI</button>
      <button onclick="switchCategory('web3')" id="menuWeb3" 
              class="px-3 py-1 text-sm font-medium rounded-md text-gray-400 hover:text-gray-200">Web3</button>
      <button onclick="switchCategory('teknologi')" id="menuTeknologi" 
              class="px-3 py-1 text-sm font-medium rounded-md text-gray-400 hover:text-gray-200">Teknologi</button>
    </div>

    <!-- Kanan: Toggle Bahasa + Tombol Forum -->
    <div class="flex items-center gap-2">
      <!-- Toggle Bahasa -->
      <div class="flex items-center gap-1">
        <button onclick="setLang('id')" id="btnId" 
                class="px-2.5 py-1 text-xs font-medium rounded-md bg-cyan-500/20 text-cyan-300 border border-cyan-500/30">ID</button>
        <button onclick="setLang('en')" id="btnEn" 
                class="px-2.5 py-1 text-xs font-medium rounded-md text-gray-400 hover:text-gray-200">ENG</button>
      </div>

      <!-- Tombol Forum -->
      <a href="Ai.html" 
         class="ml-2 bg-[rgba(0,234,255,0.15)] border border-[rgba(0,234,255,0.3)] text-white px-3 py-1.5 rounded-lg text-xs sm:text-sm transition uppercase tracking-wide no-underline flex items-center gap-1">
        Spectrum.Ai
      </a>
    </div>
  </nav>

  <!-- ===== KONTEN FORUM ===== -->
  <main id="forumMain" class="pt-20 pb-12 px-4 max-w-3xl mx-auto hidden">
    <div class="text-center mb-8">
      <h1 id="categoryTitle" class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-cyan-400 to-fuchsia-500 text-transparent bg-clip-text">Forum Kritik & Saran</h1>
      <p id="categorySubtitle" class="text-gray-400 mt-2 text-sm">Bagi kami setiap masukan sangat berharga!</p>
    </div>

    <!-- Form Tambah Topik -->
    <div class="bg-[rgba(13,20,35,0.7)] rounded-xl p-5 border border-cyan-500/20 mb-8">
      <h2 class="text-lg font-semibold mb-3 text-cyan-300">Tambahkan Topik Baru</h2>
      <input type="text" id="topicTitle" 
             class="w-full p-3 rounded-lg bg-gray-800 text-white text-sm border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-400 mb-3"
             placeholder="Judul Topik">
      <textarea id="topicContent" rows="3"
                class="w-full p-3 rounded-lg bg-gray-800 text-white text-sm border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-400"
                placeholder="Isi topik..."></textarea>
      <div class="mt-3 flex justify-end">
        <button onclick="createTopic()"
                class="px-5 py-2 bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-medium rounded-lg transition uppercase tracking-wide text-sm">
          Buat Topik
        </button>
      </div>
    </div>

    <!-- Form Kirim Komentar Utama (akan ditampilkan di semua kategori) -->
    <div id="commentFormContainer" class="bg-[rgba(13,20,35,0.7)] rounded-xl p-5 border border-cyan-500/20 mb-8">
      <!-- Rating Section (akan ditampilkan hanya di kategori "kritik") -->
      <div id="ratingSection" class="mb-3">
        <label class="block text-gray-300 text-sm mb-1">Beri Penilaian (Opsional):</label>
        <div class="flex space-x-1">
            <input type="radio" id="star5" name="rating" value="5" class="hidden peer" />
            <label for="star5" class="text-2xl text-gray-400 peer-checked:text-yellow-400 cursor-pointer">‚òÖ</label>
            <input type="radio" id="star4" name="rating" value="4" class="hidden peer" />
            <label for="star4" class="text-2xl text-gray-400 peer-checked:text-yellow-400 cursor-pointer">‚òÖ</label>
            <input type="radio" id="star3" name="rating" value="3" class="hidden peer" />
            <label for="star3" class="text-2xl text-gray-400 peer-checked:text-yellow-400 cursor-pointer">‚òÖ</label>
            <input type="radio" id="star2" name="rating" value="2" class="hidden peer" />
            <label for="star2" class="text-2xl text-gray-400 peer-checked:text-yellow-400 cursor-pointer">‚òÖ</label>
            <input type="radio" id="star1" name="rating" value="1" class="hidden peer" />
            <label for="star1" class="text-2xl text-gray-400 peer-checked:text-yellow-400 cursor-pointer">‚òÖ</label>
        </div>
      </div>

      <!-- Textarea Komentar -->
      <div id="commentInputContainer" class="mb-3">
        <textarea id="mainMessage" rows="3"
                  class="w-full p-3 rounded-lg bg-gray-800 text-white text-sm border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-400"
                  placeholder="Tulis pesan Anda..."></textarea>
      </div>

      <div class="mt-3 flex justify-end">
        <button onclick="postComment()"
                class="px-5 py-2 bg-cyan-500 hover:bg-cyan-400 text-black font-medium rounded-lg transition uppercase tracking-wide text-sm">
          Kirim
        </button>
      </div>
    </div>

    <!-- Daftar Topik dan Komentar -->
    <div id="commentsContainer" class="space-y-5">
      <!-- Topik dan Komentar akan muncul di sini -->
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js    "></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js    "></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js    "></script>
  <script>
    // Inisialisasi Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDxBWbzttv2gaPVrphK-0WcaAOY1dbTxiQ",
        authDomain: "forumdb-358d4.firebaseapp.com",
        databaseURL: "https://forumdb-358d4-default-rtdb.asia-southeast1.firebasedatabase.app/", // <- Pastikan ini benar tanpa spasi
        projectId: "forumdb-358d4",
        appId: "1:690140074859:web:767450f11d2f122177722e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth(); // Inisialisasi Auth

    // Ambil email pengguna yang login
    let currentUserEmail = null;
    let currentCategory = 'kritik'; // Default category

    // Fungsi untuk menampilkan modal konfirmasi kustom
    function showCustomConfirm(message, onConfirm, onCancel = () => {}) {
        const modal = document.getElementById('customConfirmModal');
        const messageEl = document.getElementById('customConfirmMessage');
        const okBtn = document.getElementById('customConfirmOK');
        const cancelBtn = document.getElementById('customConfirmCancel');

        // Set pesan
        messageEl.textContent = message;

        // Hapus event listener sebelumnya untuk mencegah penumpukan
        okBtn.onclick = null;
        cancelBtn.onclick = null;

        // Atur handler untuk tombol OK
        okBtn.onclick = function() {
            modal.classList.remove('animate-fade-in-up');
            modal.classList.add('animate-fade-out-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                onConfirm(); // Panggil callback jika pengguna menekan OK
            }, 300);
        };

        // Atur handler untuk tombol Cancel
        cancelBtn.onclick = function() {
            modal.classList.remove('animate-fade-in-up');
            modal.classList.add('animate-fade-out-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                onCancel(); // Panggil callback jika pengguna menekan Batal
            }, 300);
        };

        // Tampilkan modal
        modal.classList.remove('hidden');
        modal.classList.remove('animate-fade-out-down');
        modal.classList.add('animate-fade-in-up');
    }

    // --- Fungsi Like ---
    function likeTopic(topicId) {
        if (!currentUserEmail) {
            alert("Silakan login terlebih dahulu untuk menyukai topik ini.");
            return;
        }
        const sanitizedEmail = currentUserEmail.replace(/[.@]/g, '_');
        const likeRef = db.ref(`categories/${currentCategory}/topics/${topicId}/likes/${sanitizedEmail}`);
        likeRef.once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    // Sudah disukai, hapus like
                    likeRef.remove()
                        .then(() => console.log("Like dihapus dari topik."))
                        .catch(error => console.error("Gagal menghapus like dari topik: ", error));
                } else {
                    // Belum disukai, tambahkan like
                    likeRef.set(true)
                        .then(() => console.log("Like ditambahkan ke topik."))
                        .catch(error => console.error("Gagal menambahkan like ke topik: ", error));
                }
            })
            .catch(error => console.error("Gagal memeriksa status like topik: ", error));
    }

    function likeComment(commentId) {
        if (!currentUserEmail) {
            alert("Silakan login terlebih dahulu untuk menyukai komentar ini.");
            return;
        }
        const sanitizedEmail = currentUserEmail.replace(/[.@]/g, '_');
        const likeRef = db.ref(`categories/${currentCategory}/comments/${commentId}/likes/${sanitizedEmail}`);
        likeRef.once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    // Sudah disukai, hapus like
                    likeRef.remove()
                        .then(() => console.log("Like dihapus dari komentar."))
                        .catch(error => console.error("Gagal menghapus like dari komentar: ", error));
                } else {
                    // Belum disukai, tambahkan like
                    likeRef.set(true)
                        .then(() => console.log("Like ditambahkan ke komentar."))
                        .catch(error => console.error("Gagal menambahkan like ke komentar: ", error));
                }
            })
            .catch(error => console.error("Gagal memeriksa status like komentar: ", error));
    }
    // --- End Fungsi Like ---

    // Hapus topik dari Firebase
    function deleteTopic(topicId) {
        const user = auth.currentUser;
        if (!user) {
            alert("Silakan login terlebih dahulu untuk menghapus topik.");
            return;
        }

        const topicRef = db.ref(`categories/${currentCategory}/topics/${topicId}`);
        topicRef.once('value')
            .then((snapshot) => {
                const topicData = snapshot.val();
                if (!topicData) {
                    console.error("Topik tidak ditemukan.");
                    return;
                }

                if (topicData.userEmail === user.email) {
                     showCustomConfirm(
                         "Apakah Anda yakin ingin menghapus topik ini?",
                         () => {
                             topicRef.remove()
                                 .then(() => {
                                     console.log("Topik berhasil dihapus.");
                                     // renderComments akan dipanggil otomatis oleh listener
                                 })
                                 .catch(error => {
                                     console.error("Gagal menghapus topik: ", error);
                                     alert("Gagal menghapus topik.");
                                 });
                         }
                     );
                } else {
                    alert("Anda tidak berhak menghapus topik ini.");
                }
            })
            .catch(error => {
                console.error("Gagal membaca data topik untuk verifikasi: ", error);
                alert("Gagal memverifikasi pemilik topik.");
            });
    }

    // Hapus komentar dari Firebase
    function deleteComment(commentId) {
        const user = auth.currentUser; // Dapatkan user yang sedang login dari Firebase Auth
        if (!user) {
            alert("Silakan login terlebih dahulu untuk menghapus komentar.");
            return;
        }

        // Ambil referensi komentar
        const commentRef = db.ref(`categories/${currentCategory}/comments/${commentId}`);
        
        // Ambil data komentar untuk memeriksa pemiliknya
        commentRef.once('value')
            .then((snapshot) => {
                const commentData = snapshot.val();
                if (!commentData) {
                    console.error("Komentar tidak ditemukan.");
                    return;
                }

                // Bandingkan email pengguna yang login dengan email pemilik komentar
                if (commentData.userEmail === user.email) {
                     // Jika cocok, tampilkan konfirmasi dan hapus
                     showCustomConfirm(
                         "Apakah Anda yakin ingin menghapus komentar ini?",
                         () => {
                             commentRef.remove()
                                 .then(() => {
                                     console.log("Komentar berhasil dihapus.");
                                 })
                                 .catch(error => {
                                     console.error("Gagal menghapus komentar: ", error);
                                     alert("Gagal menghapus komentar.");
                                 });
                         }
                     );
                } else {
                    alert("Anda tidak berhak menghapus komentar ini.");
                }
            })
            .catch(error => {
                console.error("Gagal membaca data komentar untuk verifikasi: ", error);
                alert("Gagal memverifikasi pemilik komentar.");
            });
    }

    // Render topik dan komentar dari Firebase
    function renderComments() {
        const container = document.getElementById('commentsContainer');
        container.innerHTML = ''; // Bersihkan kontainer sebelum render

        // Ambil referensi ke topik dan komentar
        const topicsRef = db.ref(`categories/${currentCategory}/topics`);
        const commentsRef = db.ref(`categories/${currentCategory}/comments`);

        // Gabungkan data dari topik dan komentar
        Promise.all([
            topicsRef.once('value'),
            commentsRef.once('value')
        ]).then(([topicsSnapshot, commentsSnapshot]) => {
            const topics = [];
            const comments = [];

            topicsSnapshot.forEach(child => {
                // Inisialisasi likes jika tidak ada
                const topicData = { id: child.key, ...child.val(), type: 'topic' };
                if (!topicData.likes) topicData.likes = {};
                topics.push(topicData);
            });

            commentsSnapshot.forEach(child => {
                // Inisialisasi likes jika tidak ada
                const commentData = { id: child.key, ...child.val(), type: 'comment' };
                if (!commentData.likes) commentData.likes = {};
                comments.push(commentData);
            });

            // Gabungkan dan urutkan berdasarkan timestamp terbaru
            const allItems = [...topics, ...comments];
            const sorted = allItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (sorted.length === 0) {
                container.innerHTML = `<div class="text-center py-10"><p class="text-gray-500 italic">Belum ada topik atau komentar di kategori ini. Jadilah yang pertama!</p></div>`;
                return;
            }

            sorted.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-[rgba(10,18,30,0.6)] p-5 rounded-xl border border-[rgba(0,234,255,0.1)] mb-4'; // Tambahkan margin bottom

                const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString('id-ID') : 'Tidak ada waktu';
                const isOwner = item.userEmail === currentUserEmail;
                const displayAuthor = item.userEmail || 'Anonim';

                // --- Hitung dan cek like ---
                const likes = item.likes || {};
                const likeCount = Object.keys(likes).length;
                const isLikedByCurrentUser = currentUserEmail ? likes[currentUserEmail.replace(/[.@]/g, '_')] === true : false;
                // --- End Hitung dan cek like ---

                if (item.type === 'topic') {
                    // Render Topik
                    el.id = `topic-${item.id}`; // Tambahkan ID unik
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-bold text-xl text-fuchsia-300">${item.title}</span>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="font-semibold text-cyan-300">${displayAuthor}</span>
                                    <span class="text-gray-500 text-xs">${timestamp}</span>
                                </div>
                            </div>
                            ${isOwner ? `<button onclick="deleteTopic('${item.id}')" 
                                            class="text-red-400 hover:text-red-300 text-xs flex items-center gap-1 ml-2 focus:outline-none focus:ring-1 focus:ring-red-400 rounded">üóëÔ∏è Hapus Topik</button>` : ''}
                        </div>
                        <p class="text-gray-200 mt-3 whitespace-pre-wrap">${item.content || ''}</p>
                        <div class="mt-3 flex items-center gap-4">
                            <button onclick="likeTopic('${item.id}')" class="like-btn flex items-center gap-1 ${isLikedByCurrentUser ? 'text-red-500' : 'text-gray-400 hover:text-red-400'}">
                                ${isLikedByCurrentUser ? '‚ù§Ô∏è' : 'ü§ç'} <span class="like-count ml-1">${likeCount}</span>
                            </button>
                            <button onclick="focusAndMention('${item.userEmail}')" class="text-gray-400 hover:text-cyan-300 flex items-center gap-1">
                                üí¨ Komentar
                            </button>
                        </div>
                        <div class="mt-3">
                            <span class="text-sm text-gray-400">üí¨ Komentar akan muncul di bawah ini</span>
                        </div>
                    `;
                } else {
                    // Render Komentar (seperti sebelumnya)
                    let ratingHtml = '';
                    if (item.rating) {
                        let stars = '';
                        for (let i = 1; i <= 5; i++) {
                            if (i <= item.rating) {
                                stars += '‚òÖ';
                            } else {
                                stars += '‚òÜ';
                            }
                        }
                        ratingHtml = `<div class="mt-2 text-sm text-yellow-400">${stars} (${item.rating}/5)</div>`;
                    }

                    let repliesHtml = '';
                    if (item.replies && Object.keys(item.replies).length > 0) {
                        repliesHtml = `<div class="mt-4 pl-4 border-l-2 border-gray-700 space-y-3">`;
                        Object.entries(item.replies).forEach(([replyId, replyData]) => {
                            const replyTimestamp = replyData.timestamp ? new Date(replyData.timestamp).toLocaleString('id-ID') : 'Tidak ada waktu';
                            const displayReplyAuthor = replyData.userEmail || 'Anonim';
                            repliesHtml += `
                                <div class="bg-[rgba(5,12,22,0.5)] p-3 rounded-lg">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-purple-300">Balasan dari ${displayReplyAuthor}</span>
                                        <span class="text-gray-500 text-xs">${replyTimestamp}</span>
                                    </div>
                                    <p class="text-gray-300 text-sm mt-1">${replyData.text || ''}</p>
                                </div>
                            `;
                        });
                        repliesHtml += `</div>`;
                    }

                    el.id = `comment-${item.id}`; // Tambahkan ID unik
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-semibold text-cyan-300">${displayAuthor}</span>
                                <span class="text-gray-500 text-xs ml-2">${timestamp}</span>
                            </div>
                            ${isOwner ? `<button onclick="deleteComment('${item.id}')" 
                                            class="text-red-400 hover:text-red-300 text-xs flex items-center gap-1 ml-2 focus:outline-none focus:ring-1 focus:ring-red-400 rounded">üóëÔ∏è Hapus</button>` : ''}
                        </div>
                        <p class="text-gray-200 mt-3 whitespace-pre-wrap">${item.text || ''}</p>
                        ${ratingHtml}
                        <div class="mt-3 flex items-center gap-4">
                            <button onclick="likeComment('${item.id}')" class="like-btn flex items-center gap-1 ${isLikedByCurrentUser ? 'text-red-500' : 'text-gray-400 hover:text-red-400'}">
                                ${isLikedByCurrentUser ? '‚ù§Ô∏è' : 'ü§ç'} <span class="like-count ml-1">${likeCount}</span>
                            </button>
                            <button onclick="focusAndMention('${item.userEmail}')" class="text-gray-400 hover:text-cyan-300 flex items-center gap-1">
                                üí¨ Komentar
                            </button>
                        </div>

                        <div class="mt-4 flex gap-2">
                            <input type="text" id="reply-${item.id}" 
                                  placeholder="Balas komentar ini..." 
                                  class="flex-1 p-2 text-sm rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-400">
                            <button onclick="postReply('${item.id}')" 
                                    class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white rounded text-sm whitespace-nowrap">
                                Balas
                            </button>
                        </div>

                        ${repliesHtml}
                    `;
                }

                container.appendChild(el);
            });
        }).catch(error => {
            console.error("Gagal mengambil data topik atau komentar: ", error);
        });
    }


    // Fungsi untuk membuat topik baru
    function createTopic() {
        if (!currentUserEmail) {
            alert("Silakan login terlebih dahulu untuk membuat topik.");
            return;
        }
        const title = document.getElementById('topicTitle').value.trim();
        const content = document.getElementById('topicContent').value.trim();

        if (!title || !content) {
            alert('Mohon isi judul dan isi topik.');
            return;
        }

        const topicData = {
            title: title,
            content: content,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            userEmail: currentUserEmail,
            likes: {} // Inisialisasi objek likes
        };

        const topicsRef = db.ref(`categories/${currentCategory}/topics`); // Gunakan currentCategory
        topicsRef.push(topicData);

        // Reset form
        document.getElementById('topicTitle').value = '';
        document.getElementById('topicContent').value = '';
    }


    // Kirim komentar ke Firebase
    function postComment() {
        if (!currentUserEmail) {
            alert("Silakan login terlebih dahulu untuk mengirim komentar.");
            return;
        }
        const text = document.getElementById('mainMessage').value.trim();

        if (!text) {
            alert('Mohon isi pesan Anda.');
            return;
        }

        const commentData = {
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likes: {}, // Inisialisasi objek likes
            userEmail: currentUserEmail // Simpan email pengguna yang login
        };

        // Ambil rating hanya jika kategori adalah "kritik" dan elemen rating ada
        if (currentCategory === 'kritik') {
            const selectedRating = document.querySelector('input[name="rating"]:checked');
            const rating = selectedRating ? parseInt(selectedRating.value) : null;
            if (rating !== null) {
                commentData.rating = rating;
            }
        }
        // Jika bukan kategori "kritik", jangan simpan rating

        // Simpan ke Firebase di bawah kategori yang dipilih
        const commentsRef = db.ref(`categories/${currentCategory}/comments`); // Gunakan currentCategory
        commentsRef.push(commentData);

        document.getElementById('mainMessage').value = '';
        // Reset radio button rating jika ada
        if (currentCategory === 'kritik') {
            document.querySelectorAll('input[name="rating"]').forEach(radio => radio.checked = false);
        }
    }

    // Kirim balasan ke Firebase (nested di bawah komentar)
    function postReply(commentId) {
        if (!currentUserEmail) {
            alert("Silakan login terlebih dahulu untuk membalas komentar.");
            return;
        }
        const input = document.getElementById(`reply-${commentId}`);
        const text = input.value.trim();
        if (!text) return;

        const replyData = {
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            userEmail: currentUserEmail // Simpan email pengguna yang login
        };

        // Simpan ke Firebase di bawah kategori dan komentar yang dipilih
        const newReplyRef = db.ref(`categories/${currentCategory}/comments/${commentId}/replies`).push(); // Gunakan currentCategory
        newReplyRef.set(replyData).then(() => {
            input.value = '';
        }).catch(error => {
            console.error("Gagal mengirim balasan: ", error);
            alert("Gagal mengirim balasan.");
        });
    }

    // Fungsi untuk toggle bahasa
    function setLang(lang) {
        const btnId = document.getElementById('btnId');
        const btnEn = document.getElementById('btnEn');
        if (lang === 'id') {
            btnId.className = 'px-2.5 py-1 text-xs font-medium rounded-md bg-cyan-500/20 text-cyan-300 border border-cyan-500/30';
            btnEn.className = 'px-2.5 py-1 text-xs font-medium rounded-md text-gray-400 hover:text-gray-200';
        } else {
            btnId.className = 'px-2.5 py-1 text-xs font-medium rounded-md text-gray-400 hover:text-gray-200';
            btnEn.className = 'px-2.5 py-1 text-xs font-medium rounded-md bg-cyan-500/20 text-cyan-300 border border-cyan-500/30';
        }
    }

    // Fungsi untuk mengganti kategori
    function switchCategory(category) {
        currentCategory = category;

        // Update tampilan menu
        document.querySelectorAll('#mainNav button').forEach(btn => {
            btn.className = 'px-3 py-1 text-sm font-medium rounded-md text-gray-400 hover:text-gray-200';
        });
        document.getElementById(`menu${category.charAt(0).toUpperCase() + category.slice(1)}`).className = 
            'px-3 py-1 text-sm font-medium rounded-md bg-cyan-500/20 text-cyan-300 border border-cyan-500/30';

        // Update judul dan subtitle
        const titles = {
            'kritik': 'Forum Kritik & Saran',
            'Hardware & Software': 'Forum Hardware & Software',
            'ai': 'Forum Artificial Intelligence',
            'web3': 'Forum Web3 & Blockchain',
            'teknologi': 'Forum Teknologi Terkini'
        };
        const subtitles = {
            'kritik': 'Bagi kami setiap masukan sangat berharga!',
            'Hardware & Software': 'Silahkan Berdiskusi tentang permasalahan Hardware & Software Laptop/Ponsel',
            'ai': 'Masa depan teknologi cerdas dan pembelajaran mesin.',
            'web3': 'Eksplorasi dunia desentralisasi dan blockchain.',
            'teknologi': 'Semua hal terbaru dalam dunia teknologi.'
        };

        document.getElementById('categoryTitle').textContent = titles[category];
        document.getElementById('categorySubtitle').textContent = subtitles[category];

        // Perbarui tampilan form rating dan placeholder textarea
        const ratingSection = document.getElementById('ratingSection');
        const mainMessageTextarea = document.getElementById('mainMessage');

        if (category === 'kritik') {
            ratingSection.classList.remove('hidden'); // Tampilkan rating di kategori kritik
            mainMessageTextarea.placeholder = "Tulis kritik, saran, atau pengalaman Anda..."; // Placeholder khusus kritik
        } else {
            ratingSection.classList.add('hidden'); // Sembunyikan rating di kategori lain
            mainMessageTextarea.placeholder = "Tulis pesan Anda..."; // Placeholder umum
        }

        // Dengarkan perubahan real-time dari Firebase untuk kategori yang dipilih
        renderComments();
    }

    // Fungsi untuk memfokuskan textarea dan menambahkan mention
    function focusAndMention(userEmail) {
        const textarea = document.getElementById('mainMessage');
        if (textarea) {
            textarea.focus();
            const currentText = textarea.value;
            // Tambahkan @userEmail di akhir, dipisahkan oleh spasi jika diperlukan
            const mention = `@${userEmail}`;
            if (currentText.trim() === "") {
                // Jika textarea kosong, cukup tambahkan mention
                textarea.value = mention + " ";
            } else {
                // Jika tidak kosong, tambahkan spasi dan mention di akhir
                if (!currentText.endsWith(" ")) {
                    textarea.value = currentText + " " + mention + " ";
                } else {
                    textarea.value = currentText + mention + " ";
                }
            }
            // Opsional: Pindahkan kursor ke akhir teks
            textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
        }
    }

    // Fungsi untuk menangani login dengan Google
    function handleGoogleLogin() {
        console.log("Fungsi handleGoogleLogin dipanggil.");
        const provider = new firebase.auth.GoogleAuthProvider();

        // Tambahkan opsi untuk selalu meminta pemilihan akun
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        auth.signInWithPopup(provider)
            .then((result) => {
                console.log("Login popup berhasil.", result);
                // Login berhasil
                const user = result.user;
                console.log("Login berhasil sebagai:", user.email);
                currentUserEmail = user.email; // Gunakan email dari objek user Firebase

                // Sembunyikan halaman login, tampilkan navbar dan konten forum
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainNav').classList.remove('hidden');
                document.getElementById('forumMain').classList.remove('hidden');

                // Mulai mendengarkan perubahan untuk kategori default
                switchCategory(currentCategory);
            })
            .catch((error) => {
                // Tangani error login
                console.error("Error login Google:", error);
                console.error("Kode Error:", error.code);
                console.error("Pesan Error:", error.message);
                alert("Login gagal: " + error.message); // Tampilkan pesan error kepada pengguna
            });
    }

    // Muat data login dari localStorage saat halaman dimuat
    window.addEventListener('DOMContentLoaded', (event) => {
        console.log("DOMContentLoaded event fired.");
        // Pasang event listener untuk tombol Google Login
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        if (googleLoginBtn) {
             console.log("Tombol Google Login ditemukan, menambahkan event listener.");
             googleLoginBtn.addEventListener('click', handleGoogleLogin);
        } else {
             console.error("Tombol Google Login (ID: googleLoginBtn) tidak ditemukan di DOM.");
        }


        // Cek status login saat halaman dimuat
        auth.onAuthStateChanged((user) => {
            console.log("onAuthStateChanged dipanggil. User:", user);
            if (user) {
                // Jika pengguna sudah login, tampilkan forum
                console.log("Pengguna sudah login, menampilkan forum.");
                currentUserEmail = user.email;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainNav').classList.remove('hidden');
                document.getElementById('forumMain').classList.remove('hidden');
                switchCategory(currentCategory);
            } else {
                // Jika tidak, tetap tampilkan halaman login
                console.log("Pengguna belum login, menampilkan halaman login.");
                document.getElementById('loginPage').classList.remove('hidden');
            }
        });
    });

    // Ekspor fungsi ke window agar bisa dipanggil oleh onclick di HTML
    window.postComment = postComment;
    window.postReply = postReply;
    window.deleteComment = deleteComment;
    window.setLang = setLang;
    window.switchCategory = switchCategory;
    window.createTopic = createTopic;
    window.deleteTopic = deleteTopic;
    window.likeTopic = likeTopic; // Tambahkan ke window
    window.likeComment = likeComment; // Tambahkan ke window
  </script>

    <style>
  /* Background Angkasa Gelap */
  body {
    background: #000;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #fff;
    position: relative;
  }

  /* Efek Neural Biru Mengambang */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 30% 30%, rgba(0, 10, 40, 0.8) 0%, rgba(0, 0, 0, 1) 70%);
    z-index: -2;
  }

    /* Jaringan Neural - Titik-titik & Garis */
  .neural-network {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
    pointer-events: none;
  }

  canvas {
    display: block;
    width: 100%;
    height: 100%;
  }
</style>

<div class="neural-network">
  <canvas id="neuralCanvas"></canvas>
</div>

<script>
  // ===== Efek Neural Network Biru =====
  const canvas = document.getElementById("neuralCanvas");
  const ctx = canvas.getContext("2d");

  let particles = [];
  const numParticles = 60;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  for (let i = 0; i < numParticles; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.6,
      vy: (Math.random() - 0.5) * 0.6,
    });
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(0, 255, 255, 0.7)";

    particles.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
      ctx.fill();
    });

    for (let i = 0; i < numParticles; i++) {
      for (let j = i + 1; j < numParticles; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < 120) {
          ctx.strokeStyle = `rgba(0, 255, 255, ${1 - dist / 120})`;
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.stroke();
        }
      }
    }

    particles.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;

      if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
    });

    requestAnimationFrame(draw);
  }

  draw();
</script>
<!-- Modal Konfirmasi Kustom -->
<div id="customConfirmModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[9999] hidden">
    <div class="bg-[rgba(13,20,35,0.8)] rounded-xl p-6 border border-cyan-500/30 max-w-md w-full mx-4 shadow-2xl animate-fade-in-up">
        <div class="text-center mb-4">
            <h3 class="text-lg font-bold text-transparent bg-gradient-to-r from-cyan-400 to-fuchsia-500 bg-clip-text">Konfirmasi Hapus</h3>
        </div>
        <p id="customConfirmMessage" class="text-gray-300 mb-6 text-sm">Apakah Anda yakin ingin menghapus komentar ini?</p>
        <div class="flex justify-end gap-3">
            <button id="customConfirmCancel" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition">
                Batal
            </button>
            <button id="customConfirmOK" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white text-sm font-medium rounded-lg transition">
                Hapus
            </button>
        </div>
    </div>
</div>

<!-- Animasi CSS -->
<style>
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out forwards;
    }

    @keyframes fade-out-down {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(20px);
        }
    }

    .animate-fade-out-down {
        animation: fade-out-down 0.3s ease-in forwards;
    }
</style>
</body>
</html>
